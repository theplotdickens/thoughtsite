<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Brian's Thoughts</title>
<style>
  body {
    background: url('https://raw.githubusercontent.com/theplotdickens/thoughtsite/main/file_000000004bd861f7a2a2cb104.png') no-repeat center center fixed;
    background-size: cover;
    font-family: "Garamond", serif;
    margin: 0;
    font-size: 1.25em;
    height: 100vh;
    overflow-y: auto;
    color: #fff;
    text-shadow: 1px 1px 2px #000;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  button {
    color: #fff;
    border: none;
    padding: 18px 36px;
    font-size: 2.5em;
    border-radius: 8px;
    cursor: pointer;
    font-family: "Garamond", serif;
    margin-top: 12vh;
    transition: background 0.5s;
    background: hsl(0, 100%, 50%);
    white-space: pre-line;
  }
  button:disabled {
    background: #555;
    cursor: not-allowed;
  }
  button:hover:enabled {
    filter: brightness(0.85);
  }

  #thoughtBox {
    margin-top: 30px;
    width: 85%;
    max-width: 800px;
    height: 120px;
    font-size: 1.8em;
    padding: 20px;
    background: rgba(255, 255, 255, 0.9);
    color: #000;
    border: 1px solid #333;
    border-radius: 10px;
    resize: none;
    font-family: "Garamond", serif;
    overflow-y: auto;
  }

  #ratingContainer {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 20px;
    font-size: 3em;
  }
  .star {
    cursor: pointer;
    color: #bbb;
    user-select: none;
    transition: color 0.3s;
  }
  .star.selected,
  .star.hovered {
    color: gold;
  }

  #ratingInfo {
    margin-top: 10px;
    font-family: "Garamond", serif;
    color: white;
    font-style: italic;
    text-align: center;
    white-space: pre-line;
  }

  #infoText {
    margin-top: 15px;
    font-family: "Garamond", serif;
    font-style: italic;
    font-weight: bold;
    color: white;
    text-align: center;
    max-width: 85%;
  }
</style>
</head>
<body>

<button id="thoughtBtn" disabled>Loading...</button>
<textarea id="thoughtBox" readonly></textarea>

<div id="ratingContainer" aria-label="Star rating"></div>
<div id="ratingInfo">You have not rated this yet.</div>
<div id="infoText">Click the button for a new story, and give it a rating</div>

<script>
  const button = document.getElementById('thoughtBtn');
  const thoughtBox = document.getElementById('thoughtBox');
  const ratingContainer = document.getElementById('ratingContainer');
  const ratingInfo = document.getElementById('ratingInfo');

  let thoughts = [];
  let ratingsData = {};
  let currentIndex = 0;
  let userRating = null;

  // Fetch thoughts (page 1)
  async function loadThoughts() {
    try {
      const res = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRfbKJAEihBz868fJEDh4iQjNLPemxy3UoTK71Ong-HohSmZsO0lc5n_N7LuxQpqWWQp_OODIpVgBZ7/pub?output=csv');
      const text = await res.text();
      const lines = text.trim().split('\n');
      thoughts = lines.slice(1).map(line => {
        const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        return parts[1].replace(/^"|"$/g, '').trim();
      }).filter(t => t.length > 0);
      if (thoughts.length === 0) throw new Error("No thoughts found");
    } catch (e) {
      console.error("Error loading thoughts:", e);
      button.textContent = "Error loading thoughts";
      return;
    }
  }

  // Fetch ratings (page 2 - gid=1948514936)
  async function loadRatings() {
    try {
      const res = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRfbKJAEihBz868fJEDh4iQjNLPemxy3UoTK71Ong-HohSmZsO0lc5n_N7LuxQpqWWQp_OODIpVgBZ7/pub?output=csv&gid=1948514936');
      const text = await res.text();
      const lines = text.trim().split('\n');
      const sumCount = {};
      lines.slice(1).forEach(line => {
        const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        const thought = (cols[1] || '').replace(/^"|"$/g, '').trim();
        const rating = parseInt(cols[2]) || 0;
        if (!thought || rating === 0) return;
        if (!sumCount[thought]) sumCount[thought] = { sum: 0, count: 0 };
        sumCount[thought].sum += rating;
        sumCount[thought].count++;
      });
      ratingsData = {};
      Object.keys(sumCount).forEach(thought => {
        ratingsData[thought] = (sumCount[thought].sum / sumCount[thought].count).toFixed(2);
      });
    } catch (e) {
      console.error("Error loading ratings:", e);
    }
  }

  function createStars() {
    ratingContainer.innerHTML = '';
    for(let i=1; i<=5; i++) {
      const star = document.createElement('span');
      star.textContent = 'â˜…';
      star.classList.add('star');
      star.dataset.value = i;
      star.addEventListener('mouseover', () => highlightStars(i));
      star.addEventListener('mouseout', () => highlightStars(userRating || 0));
      star.addEventListener('click', () => {
        userRating = i;
        highlightStars(i);
        submitRating(thoughts[currentIndex]);
      });
      ratingContainer.appendChild(star);
    }
  }

  function highlightStars(count) {
    [...ratingContainer.children].forEach((star, idx) => {
      if (idx < count) star.classList.add('selected');
      else star.classList.remove('selected');
    });
  }

  function showThought() {
    if (thoughts.length === 0) return;
    userRating = null;
    highlightStars(0);
    const thought = thoughts[currentIndex];
    thoughtBox.value = thought;
    const avg = ratingsData[thought];
    ratingInfo.innerText = avg ? `Average rating: ${avg}\nYou have not rated this yet.` : "You have not rated this yet.";
    currentIndex = (currentIndex + 1) % thoughts.length;
  }

  async function submitRating(thought) {
    if (!userRating || !thought) return;

    // Google Form entry IDs - make sure these match your form
    const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSe_6zH53irNMjr-U3n2SGgGjAgJPlwzUGr3JPifJcuNEAZi_A/formResponse';
    const data = new URLSearchParams();
    data.append('entry.1330328457', thought);
    data.append('entry.891370315', userRating);

    try {
      await fetch(formUrl, {
        method: 'POST',
        mode: 'no-cors',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: data.toString(),
      });
      ratingInfo.innerText = `Your rating: ${userRating}\nAverage rating: ${ratingsData[thought] || 'N/A'}`;
    } catch (e) {
      console.error("Failed to send rating:", e);
    }
  }

  async function init() {
    await loadThoughts();
    await loadRatings();
    createStars();
    showThought();
    button.disabled = false;
    button.textContent = `Tell me a story\n(${thoughts.length} total)`;
    button.onclick = showThought;

    // Animate button color
    let hue = 0;
    setInterval(() => {
      hue = (hue + 2) % 360;
      button.style.background = `hsl(${hue}, 100%, 50%)`;
    }, 80);
  }

  init();
</script>

</body>
</html>
