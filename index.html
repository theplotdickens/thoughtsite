<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Brian's Thoughts</title>
  <style>
    body {
      background: url('https://raw.githubusercontent.com/theplotdickens/thoughtsite/main/file_000000004bd861f7a2f5899b2a2cb104.png') no-repeat center center fixed;
      background-size: cover;
      font-family: "Garamond", serif;
      margin: 0;
      font-size: 1.1em;
      height: 100vh;
      overflow-y: auto;
      position: relative;
      color: #fff;
      text-shadow: 1px 1px 2px #000;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    button {
      color: #fff;
      border: none;
      padding: 18px 36px;
      font-size: 2em;
      border-radius: 8px;
      cursor: pointer;
      font-family: "Garamond", serif;
      margin-top: 12vh;
      transition: background 0.5s;
      background: rgb(255, 0, 0);
      white-space: pre-line;
    }

    button:disabled {
      background: #555;
      cursor: not-allowed;
    }

    button:hover:enabled {
      filter: brightness(0.85);
    }

    #instructionText {
      margin-top: 10px;
      max-width: 90%;
      font-style: italic;
      font-weight: bold;
      font-family: "Garamond", serif;
      color: #fff;
      text-shadow: 1px 1px 2px #000;
      text-align: center;
    }

    #thoughtBox {
      margin-top: 30px;
      width: 85%;
      max-width: 800px;
      min-height: 120px;
      height: auto;
      font-size: 1.6em;
      padding: 24px;
      background: rgba(255, 255, 255, 0.95);
      color: #000;
      border: 1px solid #333;
      border-radius: 10px;
      resize: none;
      font-family: "Garamond", serif;
      overflow: hidden;
      transition: height 0.3s ease;
    }

    #recentContainer {
      margin-top: 40px;
      padding: 10px;
      max-width: 90%;
      text-align: center;
      font-size: 1em;
      font-style: italic;
      font-weight: bold;
    }

    summary {
      font-size: 1.2em;
      cursor: pointer;
      outline: none;
      padding: 10px;
      font-weight: bold;
      list-style: none;
    }

    summary::-webkit-details-marker {
      display: none;
    }

    summary::before {
      content: "+ ";
      float: left;
      margin-right: 8px;
    }

    summary::after {
      content: " +";
      float: right;
      margin-left: 8px;
    }

    details[open] summary::before {
      content: "+ ";
    }

    details[open] summary::after {
      content: " +";
    }

    #recentUpdates {
      padding-top: 10px;
    }

    .stars {
      margin-top: 20px;
      user-select: none;
      font-size: 2.8em;
      letter-spacing: 0.6em;
      color: #ccc;
      cursor: pointer;
      text-align: center;
      width: 100%;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    .star {
      display: inline-block;
      transition: color 0.3s;
    }
    .star.filled {
      color: gold;
    }

    #ratingInfo {
      margin-top: 6px;
      font-size: 1.1em;
      color: #222;
      font-weight: bold;
      font-family: "Garamond", serif;
      text-align: center;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <button id="thoughtBtn" disabled>Loading...</button>
  <div id="instructionText">Click the button for a new story,<br>and give it a rating</div>
  <textarea id="thoughtBox" readonly></textarea>

  <div class="stars" id="starsContainer" aria-label="Star rating">
    <span class="star" data-value="1">&#9733;</span>
    <span class="star" data-value="2">&#9733;</span>
    <span class="star" data-value="3">&#9733;</span>
    <span class="star" data-value="4">&#9733;</span>
    <span class="star" data-value="5">&#9733;</span>
  </div>
  <div id="ratingInfo"></div>

  <div id="recentContainer">
    <details open>
      <summary><strong><em>Recent Memory Additions</em></strong></summary>
      <div id="recentUpdates"></div>
    </details>
  </div>

<script>
  const button = document.getElementById('thoughtBtn');
  const thoughtBox = document.getElementById('thoughtBox');
  const recentDiv = document.getElementById('recentUpdates');
  const starsContainer = document.getElementById('starsContainer');
  const stars = starsContainer.querySelectorAll('.star');
  const ratingInfo = document.getElementById('ratingInfo');

  let thoughts = [];
  let index = 0;
  let isAnimating = false;

  // Map to keep track of user ratings locally by thought text
  const userRatings = new Map();

  // Store average ratings from form responses
  let averageRatings = {};

  // Google Form IDs for rating submission
  const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSe_6zH53irNMjr-U3n2SGgGjAgJPlwzUGr3JPifJcuNEAZi_A/formResponse';
  const thoughtEntry = 'entry.1611238270'; // Replace with your actual 'Thought' field ID
  const ratingEntry = 'entry.1189830351'; // Replace with your actual 'Rating' field ID

  // Shuffle array utility
  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  async function loadThoughts() {
    try {
      const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRfbKJAEihBz868fJEDh4iQjNLPemxy3UoTK71Ong-HohSmZsO0lc5n_N7LuxQpqWWQp_OODIpVgBZ7/pub?output=csv');
      const data = await response.text();
      const lines = data.trim().split(/\r?\n/);

      thoughts = lines.slice(1)
        .map(row => {
          const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
          let text = cols[1] || '';
          return text.trim().replace(/^"|"$/g, '');
        })
        .filter(t => t.length > 0);

      // Load ratings from second sheet CSV
      // We fetch the CSV of the ratings form response page specifically (adjust URL with correct gid)
      const ratingsUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRfbKJAEihBz868fJEDh4iQjNLPemxy3UoTK71Ong-HohSmZsO0lc5n_N7LuxQpqWWQp_OODIpVgBZ7/pub?output=csv&gid=1948514936';
      const ratingsResponse = await fetch(ratingsUrl);
      const ratingsData = await ratingsResponse.text();
      const ratingLines = ratingsData.trim().split(/\r?\n/);

      // Calculate average rating for each thought
      averageRatings = {};
      ratingLines.slice(1).forEach(row => {
        const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        const thoughtText = (cols[1] || '').trim().replace(/^"|"$/g, '');
        const ratingVal = parseInt(cols[2], 10);
        if (!thoughtText || isNaN(ratingVal)) return;

        if (!averageRatings[thoughtText]) {
          averageRatings[thoughtText] = { sum: 0, count: 0 };
        }
        averageRatings[thoughtText].sum += ratingVal;
        averageRatings[thoughtText].count++;
      });

      // Convert sums/counts to average numbers
      for (const thought in averageRatings) {
        const entry = averageRatings[thought];
        entry.avg = (entry.sum / entry.count).toFixed(2);
      }

      const dateCounts = {};
      lines.slice(1).forEach(row => {
        const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        const timestamp = cols[0];
        const thought = cols[1]?.trim().replace(/^"|"$/g, '');
        if (!thought) return;

        const date = new Date(timestamp);
        if (isNaN(date)) return;

        const key = date.toDateString();
        if (!dateCounts[key]) dateCounts[key] = 0;
        dateCounts[key]++;
      });

      recentDiv.innerHTML = Object.entries(dateCounts)
        .sort((a, b) => new Date(b[0]) - new Date(a[0]))
        .map(([date, count]) => `${date} â€” ${count} ${count === 1 ? 'memory' : 'memories'}`)
        .join('<br>');

      shuffle(thoughts);

      if (thoughts.length > 0) {
        showThought();
        button.disabled = false;
        button.textContent = `Tell me a story\n(${thoughts.length} total)`;
        button.addEventListener('click', showThought);
      } else {
        button.textContent = "No thoughts found";
      }
    } catch (error) {
      console.error("Failed to load thoughts or ratings:", error);
      button.textContent = "Error loading thoughts";
    }
  }

  function showThought() {
    if (isAnimating || thoughts.length === 0) return;
    isAnimating = true;

    const currentThought = thoughts[index];
    thoughtBox.value = currentThought;
    thoughtBox.style.height = 'auto';
    thoughtBox.style.height = thoughtBox.scrollHeight + 'px';

    updateStars(userRatings.get(currentThought));
    updateRatingInfo(currentThought);

    index = (index + 1) % thoughts.length;

    setTimeout(() => {
      isAnimating = false;
    }, 300);
  }

  function updateStars(rating) {
    stars.forEach(star => {
      const starVal = parseInt(star.dataset.value);
      if (rating && starVal <= rating) {
        star.classList.add('filled');
      } else {
        star.classList.remove('filled');
      }
    });
  }

  function updateRatingInfo(thought) {
    const userRating = userRatings.get(thought);
    const avgData = averageRatings[thought];

    let info = '';
    if (userRating) {
      info += `Your rating: ${userRating}`;
    } else {
      info += `You haven't rated this yet.`;
    }
    info += '\n';
    if (avgData) {
      info += `Average rating: ${avgData.avg} (${avgData.count} vote${avgData.count > 1 ? 's' : ''})`;
    } else {
      info += 'No ratings yet.';
    }
    ratingInfo.textContent = info;
  }

  // Submit rating to Google Form
  function submitRating(thoughtText, ratingValue) {
    if (!thoughtText || !ratingValue) return;

    const url = `${formUrl}?${thoughtEntry}=${encodeURIComponent(thoughtText)}&${ratingEntry}=${encodeURIComponent(ratingValue)}`;

    fetch(url, { method: 'POST', mode: 'no-cors' })
      .then(() => {
        console.log('Rating submitted:', ratingValue, 'for thought:', thoughtText);
      })
      .catch(err => {
        console.error('Submit error:', err);
      });
  }

  // Handle star click events
  stars.forEach(star => {
    star.addEventListener('click', () => {
      if (isAnimating || thoughts.length === 0) return;
      const ratingValue = parseInt(star.dataset.value);
      const currentThought = thoughts[(index + thoughts.length - 1) % thoughts.length]; // current shown thought
      userRatings.set(currentThought, ratingValue);
      updateStars(ratingValue);
      updateRatingInfo(currentThought);
      submitRating(currentThought, ratingValue);
    });

    star.addEventListener('mouseover', () => {
      const hoverVal = parseInt(star.dataset.value);
      stars.forEach(s => {
        const val = parseInt(s.dataset.value);
        s.classList.toggle('filled', val <= hoverVal);
      });
    });

    star.addEventListener('mouseout', () => {
      updateStars(userRatings.get(thoughts[(index + thoughts.length - 1) % thoughts.length]));
    });
  });

  // RGB fade for the button
  let hue = 0;
  function updateButtonColor() {
    hue = (hue + 2) % 360;
    button.style.background = `hsl(${hue}, 100%, 50%)`;
  }
  setInterval(updateButtonColor, 60);

  loadThoughts();
</script>
</body>
</html>
