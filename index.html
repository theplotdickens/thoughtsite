<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Brian's Thoughts</title>
  <style>
    body {
      background: url('https://raw.githubusercontent.com/theplotdickens/thoughtsite/main/file_000000004bd861f7a2f5899b2a2cb104.png') no-repeat center center fixed;
      background-size: cover;
      font-family: "Garamond", serif;
      margin: 0;
      font-size: 1.1em;
      height: 100vh;
      overflow-y: auto;
      position: relative;
      color: #fff;
      text-shadow: 1px 1px 2px #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }

    button {
      color: #fff;
      border: none;
      padding: 18px 36px;
      font-size: 2em;
      border-radius: 8px;
      cursor: pointer;
      font-family: "Garamond", serif;
      margin-top: 1rem;
      transition: background 0.5s;
      background: rgb(255, 0, 0);
      white-space: pre-line;
    }

    button:disabled {
      background: #555;
      cursor: not-allowed;
    }

    button:hover:enabled {
      filter: brightness(0.85);
    }

    #thoughtBox {
      margin-top: 20px;
      width: 85%;
      max-width: 800px;
      min-height: 140px;
      font-size: 1.8em;
      padding: 24px;
      background: rgba(255, 255, 255, 0.95);
      color: #000;
      border: 1px solid #333;
      border-radius: 10px;
      resize: none;
      font-family: "Garamond", serif;
      overflow: hidden;
      transition: height 0.3s ease;
    }

    #ratingContainer {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      gap: 12px; /* stars closer together */
    }

    .star {
      font-size: 3em;
      cursor: pointer;
      color: #bbb;
      transition: color 0.3s ease;
      user-select: none;
    }
    .star.filled {
      color: gold;
    }

    #ratingStatus {
      margin-top: 12px;
      font-family: "Garamond", serif;
      font-style: italic;
      font-weight: bold;
      color: white;
      text-align: center;
      max-width: 800px;
      white-space: pre-line;
    }

    #infoText {
      margin-top: 10px;
      font-family: "Garamond", serif;
      font-style: italic;
      font-weight: bold;
      color: white;
      text-align: center;
      max-width: 800px;
    }
  </style>
</head>
<body>
  <button id="thoughtBtn" disabled>Loading...</button>
  <textarea id="thoughtBox" readonly></textarea>

  <div id="ratingContainer" aria-label="Star rating" role="radiogroup">
    <span class="star" data-value="1" role="radio" aria-checked="false" tabindex="0" aria-label="1 star">★</span>
    <span class="star" data-value="2" role="radio" aria-checked="false" tabindex="-1" aria-label="2 stars">★</span>
    <span class="star" data-value="3" role="radio" aria-checked="false" tabindex="-1" aria-label="3 stars">★</span>
    <span class="star" data-value="4" role="radio" aria-checked="false" tabindex="-1" aria-label="4 stars">★</span>
    <span class="star" data-value="5" role="radio" aria-checked="false" tabindex="-1" aria-label="5 stars">★</span>
  </div>

  <div id="ratingStatus">You have not rated this thought yet.</div>

  <div id="infoText">Click the button for a new story, and give it a rating.</div>

<script>
  const button = document.getElementById('thoughtBtn');
  const thoughtBox = document.getElementById('thoughtBox');
  const stars = document.querySelectorAll('.star');
  const ratingStatus = document.getElementById('ratingStatus');

  let thoughts = [];
  let index = 0;
  let isAnimating = false;

  let ratingsData = {};
  let currentUserRating = null;

  // Replace these with your actual Google Form POST URL and entry IDs:
  const ratingFormURL = 'https://docs.google.com/forms/d/e/1FAIpQLSe_6zH53irNMjr-U3n2SGgGjAgJPlwzUGr3JPifJcuNEAZi_A/formResponse';
  const thoughtEntryID = 'entry.1389953019'; // your "Thought" question field entry ID
  const ratingEntryID = 'entry.1729801155';  // your "Rating" question field entry ID

  const thoughtsCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRfbKJAEihBz868fJEDh4iQjNLPemxy3UoTK71Ong-HohSmZsO0lc5n_N7LuxQpqWWQp_OODIpVgBZ7/pub?gid=961892928&single=true&output=csv';
  const ratingsCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRfbKJAEihBz868fJEDh4iQjNLPemxy3UoTK71Ong-HohSmZsO0lc5n_N7LuxQpqWWQp_OODIpVgBZ7/pub?gid=1948514936&single=true&output=csv';

  function shuffle(array) {
    for (let i = array.length -1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i+1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  async function fetchCSV(url) {
    const resp = await fetch(url);
    const text = await resp.text();
    return text.trim().split(/\r?\n/).slice(1).map(row => {
      const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
      return cols.map(col => col.replace(/^"|"$/g, '').trim());
    });
  }

  async function loadRatings() {
    const data = await fetchCSV(ratingsCSV);
    ratingsData = {};
    data.forEach(row => {
      const thought = row[1];
      const rating = parseInt(row[2], 10);
      if (!thought || isNaN(rating)) return;
      if (!ratingsData[thought]) ratingsData[thought] = [];
      ratingsData[thought].push(rating);
    });
  }

  function avgRating(thought) {
    const arr = ratingsData[thought] || [];
    if (arr.length === 0) return null;
    const sum = arr.reduce((a,b) => a+b, 0);
    return (sum / arr.length).toFixed(2);
  }

  function resetStars() {
    stars.forEach(star => {
      star.classList.remove('filled');
      star.setAttribute('aria-checked', 'false');
      star.tabIndex = -1;
    });
    stars[0].tabIndex = 0;
    currentUserRating = null;
    ratingStatus.textContent = "You have not rated this thought yet.";
  }

  function fillStars(rating) {
    stars.forEach(star => {
      star.classList.toggle('filled', Number(star.dataset.value) <= rating);
      star.setAttribute('aria-checked', Number(star.dataset.value) === rating ? 'true' : 'false');
    });
  }

  async function submitRating(thought, rating) {
    const formData = new FormData();
    formData.append(thoughtEntryID, thought);
    formData.append(ratingEntryID, rating);
    try {
      await fetch(ratingFormURL, {
        method: 'POST',
        mode: 'no-cors',
        body: formData
      });
    } catch(e) {
      console.warn('Submit rating failed:', e);
    }
  }

  function showThought() {
    if (isAnimating || thoughts.length === 0) return;
    isAnimating = true;

    const thought = thoughts[index];
    thoughtBox.value = thought;

    // Resize to fit text exactly
    thoughtBox.style.height = 'auto';
    thoughtBox.style.height = thoughtBox.scrollHeight + 'px';

    if (currentUserRating !== null) {
      fillStars(currentUserRating);
      const avg = avgRating(thought);
      ratingStatus.textContent = `You rated this thought ${currentUserRating} star${currentUserRating > 1 ? 's' : ''}.\nAverage rating: ${avg || 'No ratings yet'}`;
    } else {
      resetStars();
      const avg = avgRating(thought);
      ratingStatus.textContent = `You have not rated this thought yet.\nAverage rating: ${avg || 'No ratings yet'}`;
    }

    index = (index + 1) % thoughts.length;
    isAnimating = false;
  }

  function starClick(e) {
    if (!e.target.classList.contains('star')) return;
    const rating = Number(e.target.dataset.value);
    const thought = thoughtBox.value;

    currentUserRating = rating;
    fillStars(rating);
    const avg = avgRating(thought);
    ratingStatus.textContent = `You rated this thought ${rating} star${rating > 1 ? 's' : ''}.\nAverage rating: ${avg || 'No ratings yet'}`;

    submitRating(thought, rating);
  }

  function starKeyDown(e) {
    const focused = document.activeElement;
    if (!focused.classList.contains('star')) return;
    let newIndex;
    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
      e.preventDefault();
      newIndex = (Array.from(stars).indexOf(focused) + 1) % stars.length;
      stars[newIndex].focus();
    } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
      e.preventDefault();
      newIndex = (Array.from(stars).indexOf(focused) - 1 + stars.length) % stars.length;
      stars[newIndex].focus();
    } else if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      focused.click();
    }
  }

  async function init() {
    const data = await fetchCSV(thoughtsCSV);
    thoughts = data.map(row => row[1]).filter(t => t.length > 0);
    shuffle(thoughts);

    await loadRatings();

    if (thoughts.length > 0) {
      button.disabled = false;
      button.textContent = `Tell me a story\n(${thoughts.length} total)`;
      showThought();
    } else {
      button.textContent = 'No thoughts found';
    }

    button.addEventListener('click', showThought);
    document.getElementById('ratingContainer').addEventListener('click', starClick);
    document.getElementById('ratingContainer').addEventListener('keydown', starKeyDown);
  }

  init();
</script>
</body>
</html>
